<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Space Invaders</title>
    <link rel = "stylesheet" type = "text/css" href = "./css/stylesheet.css" />
    <link rel="icon" href="./res/favicon.png">
    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>

    <script>
    function init() {

      board = document.getElementById("board");
      var stage = new createjs.Stage(board);

      var cannon = new createjs.Shape();
      cannon.graphics.beginFill("DeepSkyBlue").drawRect(0, 0, 100, 50);
      cannon.x = 250;
      cannon.y = 700;
      stage.addChild(cannon);

      stage.update();

      var aliens = [];
      var lasers = [];
      var timeouts = [];
      var status = "PLAY";

      var KEYCODE_LEFT = 37,
        KEYCODE_RIGHT = 39,
        SPACE = 32;

      function keyPressed(event) {
        switch(event.keyCode) {
          case KEYCODE_LEFT:
          if (cannon.x - 5 > 0) {
            cannon.x -= 5;
          }
            break;
          case KEYCODE_RIGHT:
          if (cannon.x + 100 + 5 < board.width) {
            cannon.x += 5;
          }
            break;
          case SPACE:
            createLaser(cannon.x + 50);
            break;
        }
        stage.update();
      }

      // laser stuff

      function createLaser (x) {
        var laser = new createjs.Shape();
        laser.graphics.beginFill("Green").drawRect(0,0,5,20);
        laser.x = x;
        laser.y = 680;
        stage.addChild(laser);
        lasers.push(laser)
        handleLaserTick(laser);
      }

      function handleLaserTick(laser) {
        timeouts.push (
        setTimeout(function () {
          laser.y -= 10;
          stage.update();
            if (laser.y > -20) {
              for (var i = 0; i < aliens.length; i++) {
                var pt = laser.localToLocal(0, 0, aliens[i]);
                // Check if Hit and remove if Hit
                if (aliens[i].hitTest(pt.x, pt.y)) {
                  stage.removeChild(aliens[i]);
                  stage.removeChild(laser);
                  aliens.splice(i, 1);
                  laser.y = -20;
                  if (aliens.length === 0) {
                    console.log("you win!");
                    status = "WON";
                    pauseGame();
                    console.log(timeouts);
                  }
                }
              }
              handleLaserTick(laser);
            }
         }, 50))
       }

      // alien stuff

      function setupAliens() {
        let x = 20;
        let y = 20;

        for (var j = 0; j < 3; j++) {
          for (var i = 0; i < 5; i++) {
            createAlien(x, y);
            x += 100;
          }
          x = 20;
          y += 100;
        }
        stage.update();
      }


      function createAlien(x, y) {
        alien = new createjs.Shape();
        alien.graphics.beginFill("Red").drawRect(0,0,50,50);
        alien.x = x;
        alien.y = y;
        aliens.push(alien);
        stage.addChild(alien);
        handleAlienTick(alien); //toggled off alien movement
      }

      function handleAlienTick(alien) {
        timeouts.push (
        setTimeout(function () {
          for (var i = 0; i < aliens.length; i++) {
            if (aliens[i].x + 10 + 50 < 600) {
              aliens[i].x += 10;
            } else if (aliens[i].y < 800) {
            aliens[i].y += 100;
            aliens[i].x = 20;
          }
          var pt = aliens[i].localToLocal(0, 0, cannon);
          // Check if Hit and remove if Hit
          if (cannon.hitTest(pt.x, pt.y)) {
            status = "LOST";
            pauseGame();
          }
        }
        // if the game is not in play mode don't push more events
        if (status === "PLAY") {
          stage.update();
          handleAlienTick(alien);
        }
      }, 1000))
      }

      // ORIGINAL TICKCER FUNCTION FOR ALIENS
      // function handleAlienTick(alien) {
      //   setTimeout(function () {
      //     if (alien.x + 10 + 50 < 600) {
      //       alien.x += 10;
      //       stage.update();
      //       handleAlienTick(alien);
      //     } else if (alien.y < 800) {
      //       alien.y += 100;
      //       alien.x = 20;
      //       stage.update();
      //       handleAlienTick(alien);
      //     }
      //   }, 200)
      // }

      function pauseGame() {
        for (var i = 0; i < timeouts.length; i++) {
          clearTimeout(timeouts[i]);
        }
        timeouts = [];
      }

      setupAliens();

      // createAlien(20,20);
      // stage.update();

      this.document.onkeydown = keyPressed;

    }

    </script>
  </head>
  <body onload="init();">

    <img class="logo" src="./res/Space_invaders_logo.png"/>
    <br />
    <canvas id="board" width="600" height="800"></canvas>


  </body>
</html>
